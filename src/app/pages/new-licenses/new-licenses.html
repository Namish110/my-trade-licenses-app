<div class="container my-5">
  <div class="card shadow-lg border-0 rounded-4 ">
    <!-- HEADER -->
    <div class="card-header text-white py-3">
      <h4 class="mb-0">New Trade License Registration</h4>
      <small>Greater Bengaluru Authority</small>
    </div>

    <div class="card-body">
      <div *ngIf="currentStep === 0">
        <h6>
          {{ infoAboutIssueRelated }}
        </h6>
        <h5 class="text-center fw-bold mb-3">
          DECLARATION BY APPLICANT
        </h5>

        <div class="alert alert-light border">
          <ol class="small">
            <li>{{ infoAboutRules1 }}</li>
            <li>{{ infoAboutRules2 }}</li>
            <li>{{ infoAboutRules3 }}</li>
            <li>{{ infoAboutRules4 }}</li>
            <li>{{ infoAboutRules5 }}</li>
            <li>{{ infoAboutRules6 }}</li>
          </ol>
        </div>

        <div class="form-check mb-4">
          <input class="form-check-input" type="checkbox" [(ngModel)]="agree">
          <label class="form-check-label fw-semibold">
            I/We hereby agree to the above terms and conditions
          </label>
        </div>

        <div class="text-center">
          <button class="btn btn-primary btn-lg"
                  [disabled]="!agree"
                  (click)="startApplication()">
            Continue →
          </button>
        </div>

      </div>

      <!-- ================= STEPPER ================= -->
      <!-- ================= STEPPER ================= -->
      <div *ngIf="currentStep > 0" class="stepper-container mb-4">
        <!-- STEP 1 -->
        <div class="step" [class.active]="currentStep >= 1">
          <div class="circle">1</div>
          <span>Basic</span>
        </div>

        <div class="line" [class.active]="currentStep >= 2"></div>

        <!-- STEP 2 -->
        <div class="step" [class.active]="currentStep >= 2">
          <div class="circle">2</div>
          <span>Trade</span>
        </div>

        <div class="line" [class.active]="currentStep >= 3"></div>

        <!-- STEP 3 -->
        <div class="step" [class.active]="currentStep >= 3">
          <div class="circle">3</div>
          <span>Fee</span>
        </div>

        <div class="line" [class.active]="currentStep >= 4"></div>

        <!-- STEP 4 -->
        <div class="step" [class.active]="currentStep >= 4">
          <div class="circle">4</div>
          <span>Location</span>
        </div>

        <div class="line" [class.active]="currentStep >= 5"></div>

        <!-- STEP 5 -->
        <div class="step" [class.active]="currentStep >= 5">
          <div class="circle">5</div>
          <span>Documents</span>
        </div>

        <div class="line" [class.active]="currentStep >= 6"></div>

        <!-- STEP 6 -->
        <div class="step" [class.active]="currentStep >= 6">
          <div class="circle">6</div>
          <span>OTP</span>
        </div>

        <div class="line" [class.active]="currentStep >= 7"></div>

        <!-- STEP 7 -->
        <div class="step" [class.active]="currentStep >= 7">
          <div class="circle">7</div>
          <span>Preview</span>
        </div>

      </div>
         


      <!-- ======================================================
           STEP 1 – BASIC DETAILS
      ======================================================= -->
      <div [hidden]="currentStep !== 1">
        <h5 class="section-title required">Applicant Representation</h5>
        <div class="mb-3">
          <label class="form-check form-check-inline" *ngFor="let r of representations">
            <input type="radio" class="form-check-input" name="rep">
            {{ r }}
          </label>
        </div>

        <h5 class="section-title">Trade Details</h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="required">Trade Type</label>
            <select class="form-select" [(ngModel)]="selectedTradeType">
              <option [ngValue]="null">Select</option>
              <option *ngFor="let trade of tradeTypes" [ngValue]="trade">
                {{ trade.tradeTypeName }}
              </option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="required">Trade Name</label>
            <input class="form-control" id="tradeName" [(ngModel)]="tradeLicenseApplicationDetails.tradeName">
          </div>
          <div class="col-md-4">
            <label class="required">Application Name</label>
            <input class="form-control" id="applicationName" [(ngModel)]="tradeLicenseApplicationDetails.applicantName">
          </div>
        </div>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="required">Emaild</label>
            <input class="form-control" id="emailID" [(ngModel)]="tradeLicenseApplicationDetails.emailID" name="emailID">
          </div>
          <div class="col-md-4">
            <label class="required">Mobile No.</label>
            <input class="form-control"
              type="text"
              maxlength="10"
              [(ngModel)]="tradeLicenseApplicationDetails.mobileNumber"
              name="mobileNo">
          </div>
          <div class="col-md-4">
            <label>Telephone No.</label>
            <input class="form-control" [(ngModel)]="tradeLicenseApplicationDetails.landLineNumber">
          </div>
        </div>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="required">MLA Constituency</label>
            <select class="form-select" [(ngModel)]="selectedMLAConstituency" (change)="onMLAConstituencyChange()">
              <option [ngValue]="null">Select</option>
              <option *ngFor="let mla of mlaConstituencies" [ngValue]="mla">
                {{ mla.mohName }}
              </option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="required">Ward</label>
            <select class="form-select" [(ngModel)]="selectedWard" [disabled]="!selectedMLAConstituency">
              <option [ngValue]="null">Select</option>
              <option *ngFor="let w of wards" [ngValue]="w">
                {{ w.wardName }}
              </option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="required">BESCOM RR No.</label>
            <input class="form-control" id="bescom" [(ngModel)]="tradeLicenseApplications.bescomRRNumber">
          </div>
        </div>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="required">GST Number</label>
            <input class="form-control" id="gstNumber">
          </div>
          <div class="col-md-4">
            <label class="required">PAN Number</label>
            <input class="form-control" id="panNumber">
          </div>
        </div>

        <h5 class="section-title mt-4">Address Information</h5>
        <div class="row g-3">
          <!-- <div class="col-md-3"><input class="form-control" placeholder="Ward"></div> -->
          <div class="col-md-3"><input class="form-control" placeholder="Door No *" id="doorNo" [(ngModel)]="tradeLicenseApplicationDetails.doorNumber"></div>
          <div class="col-md-3"><input class="form-control" placeholder="Street *" id="street" [(ngModel)]="tradeLicenseApplicationDetails.address1"></div>
          <div class="col-md-3"><input class="form-control" placeholder="Area *" id="area" [(ngModel)]="tradeLicenseApplicationDetails.address2"></div>
          <div class="col-md-3"><input class="form-control" placeholder="Pincode *" id="pincode" [(ngModel)]="tradeLicenseApplicationDetails.pincode"></div>
        </div>

        <div class="text-end mt-4">
          <button class="btn btn-primary btn-lg" (click)="nextStep()">
            Continue →
          </button>
        </div>
      </div>

      <!-- ======================================================
           STEP 2 – TRADE
      ======================================================= -->
      <div *ngIf="currentStep === 2">

        <h5 class="section-title">Trade Classification (Schedule X)</h5>

        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="required">Major Trade</label>
            <select
              class="form-select"
              [(ngModel)]="selectedMajor"
              [compareWith]="compareById"
              (change)="onMajorChange()">
              <option [ngValue]="null">Select</option>
              <option *ngFor="let m of tradeMajors" [ngValue]="m">
                {{ m.tradeMajorName }}
              </option>
            </select>
          </div>


          <div class="col-md-4">
            <label class="required">Minor Trade</label>
            <select
                class="form-select"
                [(ngModel)]="selectedMinor"
                [compareWith]="compareById"
                (change)="onMinorChange()"
                [disabled]="!selectedMajor">
              <option [ngValue]="null">Select</option>
              <option *ngFor="let mi of tradeMinors" [ngValue]="mi">
                {{ mi.tradeMinorName }}
              </option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="required">Sub Trade</label>
            <select
              class="form-select"
              [(ngModel)]="selectedSub"
              [compareWith]="compareById"
              [disabled]="!selectedMinor">
              <option [ngValue]="null">Select</option>
              <option *ngFor="let s of tradeSubs" [ngValue]="s">
                {{ s.tradeSubName }}
              </option>
            </select>
          </div>
        </div>

        <div class="mt-3">
          <strong>Rate:</strong> {{ '--' }}
          <button
            type="submit"
            class="btn btn-primary ms-3"
            (click)="addTrade()">
            Add
          </button>
        </div>

        <table class="table table-bordered mt-3" *ngIf="tradeGrid.length">
          <thead class="table-primary">
            <tr>
              <th>#</th>
              <th>Major</th>
              <th>Minor</th>
              <th>Sub</th>
              <th>Rate</th>
              <th>Action</th>
            </tr>
          </thead>
          <tr *ngFor="let t of tradeGrid; let i = index">
            <td>{{ i+1 }}</td>
            <td>{{ t.major }}</td>

            <td>{{ t.minor }}</td>
            <td>{{ t.sub }}</td>
            <td>{{ t.rate }}</td>
            <td>
              <button class="btn btn-danger btn-sm" (click)="removeTrade(i)">
                Remove
              </button>
            </td>
          </tr>
          <tfoot>
            <tr>
              <th colspan="4" class="text-end">Total</th>
              <th>{{ totalAmount }}</th>
              <th></th>
            </tr>
          </tfoot>
        </table>

        <div class="d-flex justify-content-between mt-4">
          <button class="btn btn-outline-secondary" (click)="prevStep()">← Back</button>
          <button class="btn btn-primary" (click)="nextStep()">Continue →</button>
        </div>
      </div>

      <!-- ======================================================
           STEP 3 – FEE
      ======================================================= -->
      <div *ngIf="currentStep === 3">
        <h5 class="section-title">Parking Details</h5>

        <div class="row g-4">
          <div class="col-md-5 d-flex align-items-center">
            <label class="me-4 mb-0">
              Parking area provided in the said premises
            </label>

            <div class="form-check mb-0">
              <input
                class="form-check-input"
                type="radio"
                name="parkingProvided"
                id="parkingYes"
                value="yes"
              />
              <label class="form-check-label" for="parkingYes">
                Yes
              </label>
            </div>
            <div class="form-check mb-0">
              <input
                class="form-check-input"
                type="radio"
                name="parkingProvided"
                id="parkingNo"
                value="no"
              />
              <label class="form-check-label" for="parkingNo">
                No
              </label>
            </div>
          </div>
        </div>

        <h5 class="section-title">Application & Fee Details</h5>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="required">Jurisdiction of Health Officer (Zone)</label>
            <select class="form-select" [(ngModel)]="selectedZone">
              <option [ngValue]="null">Select</option>
              <option *ngFor="let z of zones" [ngValue]="z">
                {{ z.zoneName }}
              </option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="required">Date of Application</label>
            <input class="form-control" [value]="applicationDate" readonly>
          </div>
          <!-- <div class="col-md-4">
            <label>Proposed Commencement</label>
            <input type="date" class="form-control" [(ngModel)]="commencementDate">
          </div> -->
          <div class="col-md-4">
            <label class="required">Proposed Commencement</label>
            <input
              type="date"
              class="form-control"
              [(ngModel)]="commencementDate"
              (change)="bindCommencementDate()"
              required
            />
          </div>  
        </div>

        <div class="mt-3 fw-bold">
          <h5 class="section-title">Zone Classification & Compounded Licence Fees</h5>
          <div class="row g-3">
          <div class="col-md-4">
            <label class="required">Zone Classification</label>
            <select class="form-select" [(ngModel)]="selectedZoneClassification">
              <option [ngValue]="null">Select</option>
              <option *ngFor="let zc of zoneClassifications" [ngValue]="zc">
                {{ zc.zonalClassificationName }}
              </option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="required">License Fee Prescribed</label>
            <input type="text" class="form-control" [value]="licenseFee" readonly>
          </div>
        </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
          <button class="btn btn-outline-secondary" (click)="prevStep()">← Back</button>
          <button class="btn btn-primary" (click)="nextStep()">Continue →</button>
        </div>
      </div>

    <!-- ======================================================
     STEP 4 – LOCATION (GOOGLE MAP ONLY)
      ======================================================= -->
      <div *ngIf="currentStep === 4">

        <h5 class="section-title">Road Width Check (Location)</h5>

        <div class="row g-3">

          <!-- LEFT PANEL -->
          <div class="col-lg-5 col-md-6">
      <!-- CURRENT LOCATION BUTTON -->


            <!-- SEARCH (GOOGLE AUTOCOMPLETE) -->
            <label class="required">Search Location</label>
            <input
            #searchInput
            class="form-control mb-3"
            placeholder="Search location (HSR Layout, Bengaluru)"
            type="text"
            [(ngModel)]="searchText">


            <!-- LOCATION DETAILS -->
            <div class="card shadow-sm">
              <div class="card-body p-3">

                <div class="mb-2">
                  <label class="fw-semibold text-secondary">Latitude</label>
                  <input class="form-control form-control-sm" [value]="latitude" readonly>
                </div>

                <div class="mb-2">
                  <label class="fw-semibold text-secondary">Longitude</label>
                  <input class="form-control form-control-sm" [value]="longitude" readonly>
                </div>

                <div class="mb-2">
                  <label class="fw-semibold text-secondary">Road Type</label>
                  <input class="form-control form-control-sm"
                        [value]="roadWidthDetails?.roadType"
                        readonly>
                </div>

                <div class="mb-2">
                  <label class="fw-semibold text-secondary">Road Width (meters)</label>
                  <input class="form-control form-control-sm"
                        [value]="roadWidthDetails?.road_Width_mtrs"
                        readonly>
                </div>

                <div class="mb-2">
                  <label class="fw-semibold text-secondary">Road Category</label>
                  <input class="form-control form-control-sm"
                        [value]="roadWidthDetails?.roadCategory"
                        readonly>
                </div>

              </div>
            </div>
      <!-- ROAD WIDTH API STATUS MESSAGE -->
      <div *ngIf="roadWidthStatus"
          class="alert alert-info mt-2">
        {{ roadWidthStatus }}
      </div>

            <!-- CONFIRMATION -->
            <div class="card mt-3 border-start border-4 border-primary"
                *ngIf="roadWidthDetails">

              <div class="card-body p-3">
                <label class="required fw-semibold mb-2">
                  Please confirm Road Width
                </label>
                <div class="mt-2"> 
                  <p style="font-size: 0.85rem; color: #d32f2f;">
                    DISCLAIMER: ATTENTION REQUIRED-THE APPLICANT MUST VALIDATE THE ACCURACY OF THE ROAD WIDTH AUTO FETCHED /MANUALLY ENTERED IN THE APPLICATION BEING SUBMITTED. 
                    GBA WILL NOT BE HELD RESPONSIBLE FOR ANY DISCREPANCY IN THIS MATTER.
                  </p>
                </div>
                <div class="form-check">
                  <input class="form-check-input"
                        type="radio"
                        name="roadConfirm"
                        [value]="true"
                        [(ngModel)]="roadWidthConfirmed">
                  <label class="form-check-label">
                    Yes, the road width is correct
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input"
                        type="radio"
                        name="roadConfirm"
                        [value]="false"
                        [(ngModel)]="roadWidthConfirmed">
                  <label class="form-check-label">
                    No, the road width is not correct
                  </label>
                </div>
              </div>
              <!-- MANUAL ROAD WIDTH INPUT -->
                <div *ngIf="roadWidthConfirmed === false" class="mt-3">
                  <label class="required fw-semibold">
                    Enter Correct Road Width (meters)
                  </label>
                  <input
                    type="number"
                    class="form-control"
                    min="1"
                    placeholder="Enter road width manually"
                    [(ngModel)]="manualRoadWidth">
                </div>
            </div>  
          </div>

          <!-- RIGHT PANEL – GOOGLE MAP -->
        <!-- RIGHT PANEL – GOOGLE MAP -->
      <div class="col-lg-7 col-md-6">
        <small class="text-primary fw-semibold d-block mb-2">
          ⬛ Draw a rectangle on the road to calculate width
        </small>

      <google-map
        height="420px"
        width="100%"
        [center]="mapCenter"
        [zoom]="mapZoom"
        (mapReady)="onMapReady()"
        (mapClick)="onMapClick($event)">
      </google-map>

      </div>


        </div>

        <div class="d-flex justify-content-between mt-4">
          <button class="btn btn-outline-secondary" (click)="prevStep()">← Back</button>
        <button class="btn btn-primary"
              [disabled]="!canProceedRoadWidth()"
              (click)="nextStep()">
        Continue →
      </button>
        </div>

      </div>

      <!-- ======================================================
          STEP 5 – DOCUMENTS & POWER DETAILS
      ======================================================= -->
      <div [hidden]="currentStep !== 5">

        <h5 class="section-title">Documents to be Enclosed</h5>

        <table class="table table-bordered">
          <tr>
            <td class="required">Owner Consent / Lease Agreement</td>
            <td><input type="file" accept="application/pdf"
                      (change)="onFileChange($event,'ownerConsent', 1)"></td>
          </tr>
          <tr>
            <td class="required">Electricity Bill</td>
            <td><input type="file" accept="application/pdf"
                      (change)="onFileChange($event,'electricityBill', 9)"></td>
          </tr>
          <tr>
            <td>Occupancy Certificate</td>
            <td><input type="file" accept="application/pdf"
                      (change)="onFileChange($event,'oc', 8)"></td>
          </tr>
          <tr>
            <td class="required">Neighbour Consent</td>
            <td><input type="file" accept="application/pdf"
                      (change)="onFileChange($event,'neighbour', 2)"></td>
          </tr>
          <tr class="info-row">
            <td colspan="2">
              <div class="doc-help">
                <span class="doc-help-title">Document Source:</span>
                For
                <span><b>No Objection / Other Sanctions</b></span>,
                <span><b>Plan Sanction</b></span> and
                <span><b>Commencement Certificate</b></span>,
                please download from
                <a
                  href="https://bpas.bbmpgov.in/BPAMSClient4/CitizenSearch/CitizenSearch.aspx?sName=QkJNUA==&edFlag=MA==&iVal=MQ=="
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  BBMP BPAS Portal
                </a>
              </div>
            </td>
          </tr>
          <tr>
            <td>Details of no objections and other sanctions</td>
            <td><input type="file" accept="application/pdf"
                      (change)="onFileChange($event,'noc', 7)"></td>
          </tr>
          <tr>
            <td>Plan sanction details</td>
            <td><input type="file" accept="application/pdf"
                      (change)="onFileChange($event,'psd', 6)"></td>
          </tr>
          <tr>
            <td>Commencement certificate details</td>
            <td><input type="file" accept="application/pdf"
                      (change)="onFileChange($event,'ccd', 5)"></td>
          </tr>
        </table>

        <h5 class="section-title mt-4">Power / Generator Details</h5>

        <div class="row g-3">
          <div class="col-md-6">
            <label>Seeking Power License (HP)</label>
            <input type="number" class="form-control"
                  [(ngModel)]="powerHP"
                  (input)="calculateFee()">
          </div>

          <div class="col-md-6">
            <label>Installed Generator (HP)</label>
            <input type="number" class="form-control"
                  [(ngModel)]="generatorHP"
                  (input)="calculateFee()">
          </div>
        </div>

        <div class="alert alert-info mt-3">
          Power Fee (Higher of HP/KVA): ₹ {{ powerFee }}
        </div>

        <div class="d-flex justify-content-between mt-4">
          <button class="btn btn-outline-secondary" (click)="prevStep()">← Back</button>
          <button class="btn btn-primary" (click)="nextStep()">Send OTP →</button>
        </div>

      </div>
      <!-- ======================================================
          STEP 6 – OTP VERIFICATION
      ======================================================= -->
      <div *ngIf="currentStep === 6">

        <h5 class="section-title">OTP Verification</h5>

        <div *ngIf="!otpSent" class="text-center">
          <button class="btn btn-primary"
                (click)="sendOtp()"
                [disabled]="!this.tradeLicenseApplicationDetails.mobileNumber || this.tradeLicenseApplicationDetails.mobileNumber.length !== 10">
            Send OTP
          </button>
        </div>

        <div *ngIf="otpSent && !otpVerified" class="mt-3">
          <label>Enter OTP</label>
          <input class="form-control mb-2"
                [(ngModel)]="otp"
                placeholder="Enter OTP">
          <button class="btn btn-success" (click)="verifyOtp()">Verify OTP</button>
        </div>

        <div *ngIf="otpVerified" class="alert alert-success mt-3">
          OTP verified successfully.
        </div>

        <div class="d-flex justify-content-between mt-4">
          <button class="btn btn-outline-secondary" (click)="prevStep()">← Back</button>
          <button class="btn btn-primary" [disabled]="!otpVerified"
                  (click)="nextStep()">
            Continue →
          </button>
        </div>

      </div>
      <!-- ======================================================
          STEP 7 – FINAL PREVIEW
      ======================================================= -->
      <div *ngIf="currentStep === 7">

        <div class="alert alert-success fw-bold text-center">
          ✔ APPLICATION SUBMITTED SUCCESSFULLY
        </div>

        <h6>Temporary Application No:</h6>
        <strong class="fs-5 text-primary">T4RE1821K</strong>

        <h5 class="section-title mt-4">Trade & Fee Summary</h5>

        <table class="table table-bordered">
          <tr>
            <th>Trade Fee</th>
            <td>₹ {{ totalAmount }}</td>
          </tr>
          <tr>
            <th>Power Fee</th>
            <td>₹ {{ powerFee }}</td>
          </tr>
          <tr>
            <th>OC Exempted Fee</th>
            <td>₹ 500</td>
          </tr>
          <tr class="table-success fw-bold">
            <th>Total Payable</th>
            <td>₹ {{ licenseFee + powerFee + 500 }}</td>
          </tr>
        </table>

        <h5 class="section-title">Select Payment Gateway</h5>

        <div class="form-check">
          <input type="radio" class="form-check-input" checked>
          <label class="form-check-label">BillDesk</label>
        </div>

        <div class="d-flex justify-content-between mt-4">
          <button class="btn btn-outline-secondary" (click)="onClickSaveAndPayLater()">
            Save & Pay Later
          </button>
          <button class="btn btn-success btn-lg" (click)="proceedForPayment()">
            Proceed for Payment →
          </button>
        </div>
      </div>
    </div>
  </div>
</div> 